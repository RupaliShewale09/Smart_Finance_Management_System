<!-- overview.html â€” content fragment, loaded into #overviewTab by base.html -->

<!-- USER OVERVIEW -->
<div id="userOverview">
  <div class="aibar" id="aiBar">
    <span class="ai-ico">âœ¦</span>
    <p class="ai-txt" id="aiTxt">AI is analyzingâ€¦ <strong>loading your financial insights</strong></p>
  </div>

  <div class="ov-stats">
    <div class="bal-card">
      <div class="bl">Total Balance</div>
      <div class="bamt" id="walBal">â‚¹0.00</div>
      <div class="bid"  id="walId">Wallet ID: â€”</div>
      <div class="bbadges">
        <div class="bbadge"><div class="bdot"></div>AI-Monitored</div>
        <div class="bbadge" id="riskBadge">âš–ï¸ Medium Risk</div>
      </div>
      <div class="bbtns">
        <button class="bbtn" onclick="openSP()">ğŸ“± Scan &amp; Pay</button>
        <button class="bbtn" onclick="showAddMoney()">+ Add Money</button>
      </div>
    </div>
    <div class="sc">
      <div class="sc-tp"><div class="sc-ico ic-g">ğŸ’°</div><span class="sbadge sb-up">income</span></div>
      <div class="sval" id="ovInc">â‚¹0</div>
      <div class="slbl">Monthly Income</div>
    </div>
    <div class="sc">
      <div class="sc-tp"><div class="sc-ico ic-r">ğŸ’¸</div><span class="sbadge sb-dn" id="spBadge">â€”</span></div>
      <div class="sval" id="totSpent">â‚¹0</div>
      <div class="slbl">Spent This Month</div>
    </div>
    <div class="sc">
      <div class="sc-tp"><div class="sc-ico ic-y">ğŸ”¥</div><span class="sbadge sb-nu" id="urgBadge">â€”</span></div>
      <div class="sval" id="hiUrg">0</div>
      <div class="slbl">High Urgency Txns</div>
    </div>
  </div>

  <div class="card">
    <div class="chdr"><span class="ctitle">Active Alerts</span><span class="ctag" id="alertCnt">0</span></div>
    <div id="alertList"><div class="empty"><div class="ei">âœ…</div>No alerts right now</div></div>
  </div>
</div>

<!-- VENDOR OVERVIEW â€” balance only -->
<div id="vendorOverview" style="display:none">

  <!-- Business banner -->
  <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;background:linear-gradient(135deg,rgba(6,182,212,0.08),rgba(67,56,202,0.06));border:1px solid rgba(6,182,212,0.2);border-radius:var(--r);margin-bottom:20px">
    <div style="width:44px;height:44px;border-radius:13px;background:linear-gradient(135deg,var(--ac),var(--p));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;box-shadow:0 4px 12px rgba(6,182,212,0.3)">ğŸª</div>
    <div>
      <div style="font-size:15px;font-weight:800;color:var(--t1)" id="vendorBizName">Business</div>
      <div style="font-size:12px;color:var(--ac);font-weight:700" id="vendorCat">â€”</div>
    </div>
    <div style="margin-left:auto;padding:5px 14px;background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.25);border-radius:30px;font-size:11px;font-weight:800;color:var(--ac)">ğŸª Vendor Account</div>
  </div>

  <!-- Balance card only -->
  <div class="ov-stats" style="grid-template-columns:1fr">
    <div class="bal-card">
      <div class="bl">Wallet Balance</div>
      <div class="bamt" id="vWalBal">â‚¹0.00</div>
      <div class="bid" id="vWalId">Wallet ID: â€”</div>
      <div class="bbadges">
        <div class="bbadge"><div class="bdot" style="background:var(--ac)"></div>Vendor Wallet</div>
        <div class="bbadge" id="vendorCatBadge">ğŸª Business</div>
      </div>
    </div>
  </div>

</div>

<script>
  async function fetchOverviewCurrentMonth() {
    if (pType !== 'user') return;

    const fd = new FormData();
    fd.append('user_id', userId);
    fd.append('start_date', fom());
    fd.append('end_date', today());

    try {
      const d = await (
        await fetch(`${API}/insights/spending-form`, { method: 'POST', body: fd })
      ).json();

      const fmt = v => `â‚¹${parseFloat(v || 0).toFixed(0)}`;
      const ts = fmt(d.total_spent);
      const hu = d.high_urgency_expenses || 0;
      const cats = Object.keys(d.category_wise_spending || {}).length;
      const income = (prof?.income) || 1;

      const g = id => document.getElementById(id);
      if (g('totSpent')) g('totSpent').textContent = ts;
      if (g('hiUrg'))    g('hiUrg').textContent    = hu;
      if (g('spBadge'))  g('spBadge').textContent  = `${((d.total_spent / income) * 100).toFixed(0)}% income`;
      if (g('urgBadge')) g('urgBadge').textContent = `${hu} high-urgency`;
      if (g('aiTxt'))    g('aiTxt').innerHTML = `This month: spent <strong>${ts}</strong> across <strong>${cats}</strong> categories. ${hu > 2 ? 'âš ï¸ High-urgency spending detected.' : 'âœ… Spending on track.'}`;

      // Store for use by renderLimits in limits tab
      window.currentMonthSpending = d.category_wise_spending || {};

    } catch (e) {
      console.error('Overview error:', e);
    }
  }

  async function fetchVendorOverview() {
    if (pType !== 'vendor') return;

    // Show vendor overview, hide user overview
    const userOv = document.getElementById('userOverview');
    const vendorOv = document.getElementById('vendorOverview');
    if (userOv) userOv.style.display = 'none';
    if (vendorOv) vendorOv.style.display = 'block';

    // Populate from prof
    if (prof) {
      const bname = document.getElementById('vendorBizName');
      const vcat = document.getElementById('vendorCat');
      const vcatBadge = document.getElementById('vendorCatBadge');
      if (bname) bname.textContent = prof.business_name || 'Business';
      if (vcat) vcat.textContent = prof.category || 'â€”';
      if (vcatBadge) vcatBadge.textContent = `ğŸª ${prof.category || 'Vendor'}`;

      // Set balance and wallet ID using vendor-specific element IDs
      const bal = prof.wallet?.balance?.toFixed(2) ?? '0.00';
      const wid = prof.wallet?.wallet_id ?? 'â€”';
      const vb = document.getElementById('vWalBal');
      const vi = document.getElementById('vWalId');
      if (vb) vb.textContent = `â‚¹${bal}`;
      if (vi) vi.textContent = `Wallet ID: ${wid}`;
    }
  }

  async function fetchAlerts() {
    if (pType !== 'user') return;

    try {
      const d = await (await fetch(`${API}/spend/alerts/${userId}`)).json();
      const alerts = d.alerts || [];

      const html = alerts.length
        ? alerts.map(a => `
            <div class="ait ${a.type === 'danger' ? 'd' : 'w'}">
              <span style="font-size:16px">${a.type === 'danger' ? 'ğŸš¨' : 'âš ï¸'}</span>
              <div>
                <div class="attl">${a.category || 'Alert'}</div>
                <div class="amsg">${a.message}</div>
              </div>
            </div>
          `).join('')
        : '<div class="empty"><div class="ei">âœ…</div>No limit alerts this month</div>';

      ['alertList', 'limAlerts'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
      });

      const ac = document.getElementById('alertCnt');
      if (ac) ac.textContent = alerts.length > 0 ? `${alerts.length} active` : '0';

      const lac = document.getElementById('limAlertCnt');
      if (lac) lac.textContent = `${alerts.length} alert${alerts.length !== 1 ? 's' : ''}`;

    } catch (e) {
      console.error('Alert error:', e);
    }
  }
</script>